#!/usr/bin/env zsh

fpath+=("${_ZPM_DIR}/functions" "${ZSH_TMP_DIR}/functions")

function _msg() {
  local status="$1"
  local action_label skip_label fail_label msg color symbol

  if [[ "$Command" == "install" ]]; then
    action_label='Install'
    skip_label='Skip install'
    fail_label="Can't install"
  else
    action_label='Upgrade'
    skip_label='Skip upgrade'
    fail_label="Can't upgrade"
  fi

  case "$status" in
    skip)
      msg="$skip_label"
      color="${c[yellow]}${c[bold]}"
      symbol='âœ—'
      ;;
    0)
      msg="$action_label"
      color="${c[green]}${c[bold]}"
      symbol='âœ“'
      ;;
    *)
      msg="$fail_label"
      color="${c[red]}${c[bold]}"
      symbol='âœ—'
      ;;
  esac

  echo "${color}${c[bold]}${msg}${c[reset]} ${Plugin_documentation_hyperlink} ${color}${symbol}${c[reset]}"
}

if [[ "$CLICOLOR" != "0" ]]; then
  typeset -gA c=(
    reset "[0m"
    bold "[1m"

    black "[30m"
    red "[31m"
    green "[32m"
    yellow "[33m"
    blue "[34m"
    magenta "[35m"
    cyan "[36m"
    white "[37m"
  )
fi

autoload -Uz                              \
  @zpm-get-plugin-basename                \
  @zpm-get-plugin-documentation-hyperlink \
  @zpm-get-plugin-documentation-link      \
  @zpm-get-plugin-name                    \
  @zpm-get-plugin-origin                  \
  @zpm-get-plugin-origin-type             \
  @zpm-get-plugin-path                    \
  @zpm-get-plugin-type                    \
  @zpm-get-plugin-vcs-root-path           \
  @zpm-get-plugin-destination-path        \
  @zpm-log


(( $#_ZPM_autoload )) && autoload -Uz -- ${(z)_ZPM_autoload}

local Command="$1"
local Plugin="$2"
local Plugin_name=$(@zpm-get-plugin-name "$Plugin")
local Plugin_type=$(@zpm-get-plugin-type "$Plugin_name")
local Plugin_basename=$(@zpm-get-plugin-basename "$Plugin_name")
local Plugin_path=$(@zpm-get-plugin-path "$Plugin_name" "$Plugin_type")
local Plugin_origin_type=$(@zpm-get-plugin-origin-type "$Plugin_name")
local Plugin_origin=$(@zpm-get-plugin-origin "$Plugin" "$Plugin_name" "$Plugin_basename" "$Plugin_type" "$Plugin_origin_type")
local Plugin_documentation_link=$(@zpm-get-plugin-documentation-link "$Plugin_name" "$Plugin_type" "$Plugin_origin")
local Plugin_documentation_hyperlink=$(@zpm-get-plugin-documentation-hyperlink "$Plugin_name" "$Plugin_documentation_link" "$Plugin_origin")
local Plugin_destination_path=$(@zpm-get-plugin-destination-path "$Plugin" "$Plugin_path" "$Plugin_basename" "$Plugin_origin_type")

if [[ "$Command" == "upgrade" ]]; then
  @zpm-log zpm:upgrade "Upgrade '${Plugin}'"
elif [[ "$Command" == "install" ]]; then
  @zpm-log zpm:install "Install '${Plugin}'"
else
  echo Unknown command
fi

local destination_parent="${Plugin_destination_path:h}"
local status=0

case "$Plugin_origin_type" in
  git)
    if [[ "$Command" == 'install' ]]; then
      mkdir -p "${destination_parent}" || status=$?
      if [[ $status -eq 0 ]]; then
        git clone --recursive "${Plugin_origin}" --depth 1 --single-branch "${Plugin_destination_path}" </dev/null >/dev/null 2>/dev/null || status=$?
      fi
    else
      git --git-dir="${Plugin_destination_path}/.git/" --work-tree="${Plugin_destination_path}" pull </dev/null >/dev/null 2>/dev/null || status=$?
    fi
    ;;
  remote)
    mkdir -p "${destination_parent}" || status=$?
    if [[ $status -eq 0 ]]; then
      curl -fSL --silent "${Plugin_origin}" --output "${Plugin_destination_path}" 2>/dev/null || status=$?
    fi
    ;;
  dir-link)
    if [[ "$Command" == 'install' ]]; then
      ln -sf "${Plugin_origin}" "${Plugin_destination_path}" 2>/dev/null
      status=$?
    else
      status='skip'
    fi
    ;;
  file-link)
    if [[ "$Command" == 'install' ]]; then
      mkdir -p "${destination_parent}" || status=$?
      if [[ $status -eq 0 ]]; then
        ln -sf "${Plugin_origin}" "${Plugin_destination_path}" 2>/dev/null || status=$?
      fi
    else
      status='skip'
    fi
    ;;
  exec)
    mkdir -p "${destination_parent}" || status=$?
    if [[ $status -eq 0 ]]; then
      (
        cd "${destination_parent}" || exit 1
        eval "$Plugin_origin" 1>! "${Plugin_destination_path}" 2>/dev/null
      ) || status=$?
    fi
    ;;
  empty)
    mkdir -p "${Plugin_path}" || status=$?
    ;;
  *)
    status='skip'
    ;;
esac

_msg "$status"

if [[ "$Plugin" == *',destination:bin'* ]]; then
  chmod +x "${Plugin_destination_path}" >/dev/null 2>/dev/null
fi

if [[ "$Plugin" == *',hook:'* && -e "$Plugin_path" ]]; then
  local hook_command="${${Plugin##*,hook:}%%\,*}"
  if [[ -n "$hook_command" ]]; then
    (
      cd "$Plugin_path" || exit 1
      eval "$hook_command" >/dev/null
    )
    echo "${c[green]}${c[bold]}Run hook for${c[reset]} ${Plugin_documentation_hyperlink} ${c[green]}âœ“${c[reset]}"
  fi
fi
