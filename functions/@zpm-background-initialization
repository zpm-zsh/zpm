#!/usr/bin/env zsh

rehash
compinit -i -d "${_ZPM_COMPDUMP}"
unfunction source 2>/dev/null

echo "$is" >! "$ZSH_TMP_DIR/is"

local cache_tmp="$(mktemp)"
local cache_tmp_async="$(mktemp)"

function _zpm_emit_plugin_stub() {
  local plugin="$1"
  local file="$2"
  local target="$3"

  [[ -n "$file" && -f "$file" ]] || return 0

  {
    print -r -- '(){'
    print -r -- "0=${(qqq)file}"

    if [[ "$plugin" == "romkatv/powerlevel10k" ]]; then
      local plugin_path=$(@zpm-get-plugin-path "$plugin")
      print -r -- "export POWERLEVEL9K_INSTALLATION_DIR=${(qqq)plugin_path}"
    fi

    cat -- "$file"
    print -r -- '}'
    print -r --
  } >> "$target"
}

{
  print -r -- "autoload -Uz -- @zpm-clean $_ZPM_autoload"
  print -r --
  print -r -- 'compinit -i -C -d "${_ZPM_COMPDUMP}"'
  print -r --

  if (( ${#_ZPM_plugins_for_source} )); then
    local plugin
    for plugin in "${_ZPM_plugins_for_source[@]}"; do
      local file="${_ZPM_file_for_source[$plugin]}"
      _zpm_emit_plugin_stub "$plugin" "$file" "$cache_tmp"
    done
  fi

  print -r -- "sched +0 source '$_ZPM_CACHE_ASYNC'"
  print -r --

  print -r -- 'if [[ -s $ZSH_TMP_DIR/is ]]; then'
  print -r -- '  if [[ "$is" != "$(<$ZSH_TMP_DIR/is)" ]]; then'
  print -r -- '    @zpm-clean'
  print -r -- '  fi'
  print -r -- 'fi'
  print -r --
  print -r --
  print -r -- 'zpm () {}'
} >> "$cache_tmp"

{
  print -r -- "$(typeset -p _ZPM_plugins_full)"
  print -r -- 'unfunction zpm'
  print -r -- "$(typeset -p _zpm_parallel_format)"
  print -r -- "$(typeset -p _zpm_parallel_launcher)"
  print -r -- "$(typeset -p _zpm_parallel_item)"
  print -r --

  if (( ${#_ZPM_plugins_for_async_source} )); then
    local plugin
    for plugin in "${_ZPM_plugins_for_async_source[@]}"; do
      local file="${_ZPM_file_for_async_source[$plugin]}"
      _zpm_emit_plugin_stub "$plugin" "$file" "$cache_tmp_async"
    done
  fi

  print -r -- 'zle && zle reset-prompt'
  print -r -- "sched +0 source ${_ZPM_DIR}/lib/init.zsh"
} >> "$cache_tmp_async"

mv "$cache_tmp" "$_ZPM_CACHE"
mv "$cache_tmp_async" "$_ZPM_CACHE_ASYNC"

unset -f _zpm_emit_plugin_stub

(@zpm-compile 2>/dev/null &)
